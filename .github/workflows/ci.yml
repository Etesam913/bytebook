name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # ------------------------------------------------------------------
  # JOB 1: Backend Setup, Test, and Bindings Generation
  # ------------------------------------------------------------------
  backend-and-bindings:
    name: Backend Setup & Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libglib2.0-dev libsoup-3.0-dev libzmq3-dev

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      # Clones Wails v3 Alpha and installs the CLI
      - name: Setup Wails v3 Source
        run: |
          git clone https://github.com/wailsapp/wails.git
          cd wails
          git checkout v3-alpha
          cd v3/cmd/wails3
          go install

      - name: Fix Wails replace directive
        run: |
          sed -i 's|replace github.com/wailsapp/wails/v3 => ../wails/v3|replace github.com/wailsapp/wails/v3 => ./wails/v3|g' go.mod
          go mod tidy

      - name: Run Go Tests
        # Runs tests while the wails source and modified go.mod are present
        run: |
          go install gotest.tools/gotestsum@latest
          gotestsum --format=pkgname --format-icons=hivis ./internal/...

      # We need Bun here just to run the 'wails3 generate bindings' command
      - name: Setup Bun (for bindings)
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: bun install

      - name: Generate Wails bindings
        run: wails3 generate bindings

      # Uploads the bindings so the other jobs can download them
      - name: Upload Bindings Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wails-bindings
          path: frontend/bindings
          retention-days: 1

  # ------------------------------------------------------------------
  # JOB 2: Frontend Checks (Lint/Typecheck)
  # ------------------------------------------------------------------
  frontend-checks:
    name: Frontend Checks
    runs-on: ubuntu-latest
    needs: backend-and-bindings

    steps:
      # Uses the custom action from File 1
      - name: Setup Frontend Environment
        uses: ./.github/actions/setup-frontend

      - name: Download Bindings
        uses: actions/download-artifact@v4
        with:
          name: wails-bindings
          path: frontend/bindings

      - name: Run Prettier check
        working-directory: ./frontend
        run: bun run format:check

      - name: Run ESLint check
        working-directory: ./frontend
        run: bun run lint:check

      - name: Run TypeScript check
        working-directory: ./frontend
        run: bun run tsgo

  # ------------------------------------------------------------------
  # JOB 3: Playwright Tests
  # ------------------------------------------------------------------
  playwright-tests:
    name: Playwright Tests
    runs-on: ubuntu-latest
    needs: backend-and-bindings

    steps:
      # Uses the custom action from File 1
      - name: Setup Frontend Environment
        uses: ./.github/actions/setup-frontend

      - name: Download Bindings
        uses: actions/download-artifact@v4
        with:
          name: wails-bindings
          path: frontend/bindings

      # Cache Playwright Browsers specifically
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('frontend/bun.lock') }}

      # Only download browsers if the cache was NOT found
      - name: Install Playwright Browsers
        working-directory: ./frontend
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install --with-deps

      - name: Run Playwright tests
        working-directory: ./frontend
        run: bun run test:e2e

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30
